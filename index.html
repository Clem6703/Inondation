<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exposition Inondations - Comparateur</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }

        /* Titre */
        #map-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center;
            border: 1px solid #ddd;
        }
        #map-title h1 { margin: 0; font-size: 18px; color: #c0392b; text-transform: uppercase; letter-spacing: 1px; }
        #map-title p { margin: 2px 0 0 0; font-size: 12px; color: #7f8c8d; }

        /* Panneau Info */
        .info {
            padding: 12px;
            font: 13px/16px Arial, Helvetica, sans-serif;
            background: rgba(255,255,255,0.96);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            min-width: 260px;
        }
        .info h4 { margin: 0 0 8px; color: #333; font-size: 16px; border-bottom: 2px solid #c0392b; padding-bottom: 5px; text-transform: uppercase; }

        /* Tableaux */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
        .data-table th { text-align: left; color: #777; font-size: 0.9em; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
        .data-table td { padding: 4px 0; border-bottom: 1px solid #eee; }
        .val-zi { color: #c0392b; font-weight: bold; }
        .val-hors { color: #2d3436; }

        /* Légende */
        .legend { line-height: 20px; color: #555; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.8; border: 1px solid #ccc; }
        
        .leaflet-control-layers { box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-radius: 8px; }
    </style>
</head>
<body>

<div id="map-title">
    <h1>Représentation des unités urbaines soumises à un risque d'inondation</h1>
    <p>Comparaison socio-démographique (1999 - 2017)</p>
</div>

<div id="map"></div>

<script type="text/javascript" src="inondation_1999_wgs84.json"></script>
<script type="text/javascript" src="inondation_2008_wgs84.json"></script>
<script type="text/javascript" src="inondation_2017_wgs84.json"></script>
<script type="text/javascript" src="cours_eau.json"></script>
    
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // --- 1. CONFIGURATION DES FONDS ---
    var basemapSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
    });
    
    var basemapGris = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CARTO'
    });

    // On démarre avec le Satellite
    var map = L.map('map', {
        center: [46.6, 2.5],
        zoom: 6,
        layers: [basemapGris] 
    });

    L.control.scale({ position: 'bottomleft', metric: true, imperial: false }).addTo(map);

    // --- 2. STYLE & FUNCTIONS ---
    function getColor(d) {
        return d > 0.50 ? '#800026' : 
               d > 0.25 ? '#BD0026' : 
               d > 0.15 ? '#E31A1C' : 
               d > 0.10 ? '#FC4E2A' : 
               d > 0.05 ? '#FD8D3C' : 
               d > 0.02 ? '#FEB24C' : 
               d > 0    ? '#FFEDA0' : '#CCCCCC'; 
    }

    function formatPct(val) {
        if (val === null || val === undefined) return '<span style="color:#ccc">N/A</span>';
        return (val * 100).toFixed(1) + '%';
    }

    function style(feature) {
        return {
            fillColor: getColor(feature.properties.PCT_EXPO),
            weight: 0.5,        
            opacity: 1,
            color: 'black',     
            fillOpacity: 0.7
        };
    }

    var styleEau = { color: "#4FC3F7", weight: 0.8, opacity: 0.6 };
    
    var layerEau;
    try {
        if (typeof EAU !== 'undefined') {
            layerEau = L.geoJSON(EAU, { style: styleEau });
            layerEau.addTo(map);
        }
    } catch(e) {}

    // --- INFO PANEL ---
    var info = L.control();
    info.onAdd = function (map) { this._div = L.DomUtil.create('div', 'info'); this.update(); return this._div; };
    info.update = function (props) {
        if (props) {
            var pop = props.POP_ZI !== null ? Math.round(props.POP_ZI) : 0;
            var html = '<h4>' + props.libuu2020 + ' (' + props.annee + ')</h4>' +
                '<b>Exposition : ' + formatPct(props.PCT_EXPO) + ' de la population.</b><br>' +
                '<span style="color:#777; font-size:0.9em">' + pop.toLocaleString() + ' habitants en zone inondable (ZI)</span>' +
                '<hr style="border:0; border-top:1px solid #eee; margin:8px 0;">' +
                '<table class="data-table">' +
                    '<tr><th>Résidents</th><th>En ZI</th><th>Hors ZI</th></tr>' +
                    '<tr><td>Propriétaires</td><td class="val-zi">' + formatPct(props.PCT_PROP_Z) + '</td><td class="val-hors">' + formatPct(props.PCT_PROP_H) + '</td></tr>' +
                    '<tr><td>Étrangers</td><td class="val-zi">' + formatPct(props.PCT_ETR_ZI) + '</td><td class="val-hors">' + formatPct(props.PCT_ETR_HO) + '</td></tr>' +
                    '<tr><td>Chômage</td><td class="val-zi">' + formatPct(props.PCT_CHOM_Z) + '</td><td class="val-hors">' + formatPct(props.PCT_CHOM_H) + '</td></tr>' +
                '</table>' +
                '<br><small style="color:#777">Survolez pour les détails</small>';
            this._div.innerHTML = html;
        } else {
            this._div.innerHTML = '<h4>Informations unité urbaine</h4>Survolez une commune !<br>';
        }
    };
    info.addTo(map);

    // --- INTERACTIONS ---
    function highlightFeature(e) {
        var layer = e.target;
        layer.setStyle({ weight: 2, color: 'black', fillOpacity: 0.9 });
        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { layer.bringToFront(); }
        if(layerEau) layerEau.bringToFront(); 
        info.update(layer.feature.properties);
    }
    function resetHighlight(e) { var layer = e.target; layer.setStyle(style(layer.feature)); info.update(); }
    function zoomToFeature(e) { map.fitBounds(e.target.getBounds()); }
    function onEachFeature(feature, layer) { layer.on({ mouseover: highlightFeature, mouseout: resetHighlight, click: zoomToFeature }); }

    // --- CHARGEMENT DONNÉES AVEC FILTRE ---
    
    // Fonction de filtrage commune pour ne pas afficher les données nulles
    function filterData(feature) {
        // Retourne 'true' si PCT_EXPO n'est PAS null, 'false' sinon.
        // Si vous voulez aussi cacher les 0%, utilisez : 
        // return feature.properties.PCT_EXPO !== null && feature.properties.PCT_EXPO > 0;
        return feature.properties.PCT_EXPO !== null;
    }

    try {
        if (typeof INONDATION1999 === 'undefined') INONDATION1999 = {"type":"FeatureCollection","features":[]};
        if (typeof INONDATION2008 === 'undefined') INONDATION2008 = {"type":"FeatureCollection","features":[]};
        if (typeof INONDATION2017 === 'undefined') INONDATION2017 = {"type":"FeatureCollection","features":[]};
    } catch(e){}

    // On ajoute l'option 'filter' ici
    var layer1999 = L.geoJSON(INONDATION1999, { style: style, onEachFeature: onEachFeature, filter: filterData });
    var layer2008 = L.geoJSON(INONDATION2008, { style: style, onEachFeature: onEachFeature, filter: filterData });
    var layer2017 = L.geoJSON(INONDATION2017, { style: style, onEachFeature: onEachFeature, filter: filterData });

    // Activation par défaut de 2017
    layer2017.addTo(map);
    map.fitBounds(layer2017.getBounds());

    // --- 4. GESTION MENU COUCHES ---
    var baseMaps = {
        "ESRI Satellite": basemapSat,
        "Plan Gris (CartoDB)": basemapGris
    };
    
    var overlayMaps = {
        "Année 1999": layer1999,
        "Année 2008": layer2008,
        "Année 2017": layer2017
    };
    
    if (layerEau) overlayMaps["Cours d'eau"] = layerEau;

    L.control.layers(baseMaps, overlayMaps, { collapsed: false, autoZIndex: false }).addTo(map);


    // --- 5. LOGIQUE D'EXCLUSIVITÉ ---
    map.on('overlayadd', function(e) {
        var years = [layer1999, layer2008, layer2017];
        var addedLayer = e.layer;
        if (years.indexOf(addedLayer) !== -1) {
            years.forEach(function(yearLayer) {
                if (yearLayer !== addedLayer && map.hasLayer(yearLayer)) {
                    setTimeout(function() {
                        map.removeLayer(yearLayer);
                    }, 0);
                }
            });
        }
    });


    // --- LEGENDE ---
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend'),
            grades = [0, 0.02, 0.05, 0.10, 0.15, 0.25, 0.50];

        div.innerHTML = '<h4>Part Pop. Exposée</h4>';
        
        // J'ai retiré la ligne "0 ou N/A" de la légende car ces données sont maintenant masquées
        // div.innerHTML += '<i style="background:#CCCCCC; border:1px solid #ccc"></i> 0 ou N/A<br>';

        for (var i = 0; i < grades.length; i++) {
            var label = (grades[i] * 100) + '%';
            var nextLabel = grades[i + 1] ? '&ndash;' + (grades[i + 1] * 100) + '%' : '+';
            div.innerHTML +=
                '<i style="background:' + getColor(grades[i] + 0.0001) + '; border:1px solid #ccc"></i> ' +
                label + (grades[i + 1] ? nextLabel : '+') + '<br>';
        }
        div.innerHTML += '<br><i style="background:#4FC3F7; height:2px; margin-top:9px;"></i> Cours d\'eau';
        return div;
    };
    legend.addTo(map);

</script>

</body>
</html>
